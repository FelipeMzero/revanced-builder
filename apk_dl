#!/usr/bin/env -S node --no-warnings
(()=>{"use strict";var e={210:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"configOf",{enumerable:!0,get:()=>o});const r={youtube:{frontWebPageURL:"https://www.apkmirror.com/apk/google-inc/youtube",feedURL:"https://www.apkmirror.com/apk/google-inc/youtube/variant-%7B%22dpis_slug%22%3A%5B%22nodpi%22%5D%7D/feed/",patchName:"general-ads",packageName:"com.google.android.youtube",apkmirrorLinkByVersion:e=>`https://www.apkmirror.com/apk/google-inc/youtube/youtube-${e}-release/youtube-${e}-2-android-apk-download/`,regExVersion:/YouTube ([\d.]+)/},tiktok:{frontWebPageURL:"https://www.apkmirror.com/apk/tiktok-pte-ltd/tik-tok",feedURL:"https://www.apkmirror.com/apk/tiktok-pte-ltd/tik-tok/variant-%7B%22dpis_slug%22%3A%5B%22nodpi%22%5D%7D/feed/",patchName:"feed-filter",packageName:"com.ss.android.ugc.trill",apkmirrorLinkByVersion:e=>`https://www.apkmirror.com/apk/tiktok-pte-ltd/tik-tok/tik-tok-${e}-release/tiktok-${e}-2-android-apk-download/`,regExVersion:/TikTok ([\d.]+)/}};function o(e){return{...r[e],name:e}}},606:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{getWebDownloadURL:()=>a,getRawFeeds:()=>i});const o=r(81),n=r(781);async function a(e,t){let r=await i(e);if(!r.length)throw Error("Empty feeds.");if(!t)return r[0];let o=r.find((e=>e.title.includes(t)&&!e.title.includes("beta")));if(!o)throw Error("No item found");return o}function i(e){return console.error("Getting raw feeds ..."),new Promise(((t,r)=>{let a=n.Readable.from(["curl --fail -s \"$1/variant-%7B%22dpis_slug%22%3A%5B%22nodpi%22%5D%7D/feed/\" | yq -p xml -M -o=json '.rss.channel.item'"]),i=(0,o.spawn)("bash",["-o","pipefail","-e","-s","-",e],{stdio:[null,"pipe","inherit"]});a.pipe(i.stdin),i.once("exit",(async e=>{if(e)return console.error("Error. Exit code:",e),r(Error("Exec error"));let o=(await async function(e){let t=[];for await(let r of e)t.push(r);return Buffer.concat(t).toString("utf8")}(i.stdout)).trim(),n=JSON.parse(o);t(n)}))}))}},904:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"getLatest",{enumerable:!0,get:()=>a});const o=r(606),n=r(404);async function a(e){let t=await(0,o.getWebDownloadURL)(e.frontWebPageURL),r=t.title.match(e.regExVersion)[1];return console.error("Getting link ..."),{version:r,apkURL:await(0,n.getApkURL)(e,r,t.link)}}},821:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{getPatches:()=>i,getCompatibleVersion:()=>s});const o=r(147),n=function(e){return e&&e.__esModule?e:{default:e}}(r(292)),a=r(404);async function i(){let e="patches.json";if(console.error("Geting latest patch info ..."),(0,o.existsSync)(e))return console.error("Load from cache"),JSON.parse(await n.default.readFile(e,"utf-8"));let t=await(0,a.fetchjson)(`https://github.com/revanced/revanced-patches/releases/latest/download/${e}`);return await n.default.writeFile(e,JSON.stringify(t),"utf-8"),console.error("File cached"),t}async function s(e){let t=(await i()).find((t=>t.name===e.patchName));if(!t)throw Error(`${e.patchName} patch no found for app ${e}`);console.error("Compatible Packages:",t?t.compatiblePackages:t);let r=t.compatiblePackages.find((t=>t.name===e.packageName));return r.versions.length?r.versions.slice(-1)[0]:"latest"}},404:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{fetchtext:()=>n,fetchjson:()=>a,amURLByVersion:()=>i,getApkURL:()=>s,getApkMirrorFeed:()=>c});const o=r(606);function n(e){return fetch(e,{headers:{"user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"}}).then((e=>e.text()))}function a(e){return fetch(e,{redirect:"follow",headers:{"user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"}}).then((e=>e.json()))}async function i(e,t){let r=await c(e.feedURL),o=r.items.find((e=>e.title.includes(t)));if(o)return o.url;console.error(`[WARN] Version ${t} not found in feed ${e.feedURL}. Oldest: ${r.items.slice(-1)[0]?.title}`);let n=e.apkmirrorLinkByVersion(t.replace(/\./g,"-"));return console.error(`Using fallback URL version: ${n}`),n}async function s(e,t,r){let a=r||(await(0,o.getWebDownloadURL)(e.frontWebPageURL,t)).link,i=(await n(a)).match(/download\/\?key=([^&"]+)/)[1],[s]=(await n(`${a}download/?key=${i}&forcebaseapk=true`)).match(/id=\d+&key=([^&"]+)/);return`https://www.apkmirror.com/wp-content/themes/APKMirror/download.php?${s}&forcebaseapk=true`}async function c(e){return a(`https://www.toptal.com/developers/feed2json/convert?url=${encodeURIComponent(e)}`)}},81:e=>{e.exports=require("child_process")},147:e=>{e.exports=require("fs")},292:e=>{e.exports=require("fs/promises")},781:e=>{e.exports=require("stream")}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,r),a.exports}(()=>{const e=r(210),t=r(904),o=r(821),n=r(404);function a(e){console.error("APK version:",e.version),console.log(`\nexport APK_VERSION="${e.version}"\nexport APK_URL="${e.apkURL}"\n  `.trim())}!async function(){let[r,i]=function(){let e=process.argv.slice(2)[0]||"",[t,r]=e.split("_");return"youtube"!==t&&"tiktok"!==t&&(console.error("Unsupported app",t),process.exit(1)),"compatible"!==r&&"latest"!==r&&(console.error("Unsupported version:",r),process.exit(1)),[t,r]}(),s=(0,e.configOf)(r);if("latest"===i)a(await(0,t.getLatest)(s));else{console.error("Checking compatible version for app:",s.name);let e=await(0,o.getCompatibleVersion)(s);console.error(`${s.name} ==>`,e),a("latest"===e?await(0,t.getLatest)(s):{version:e,apkURL:await(0,n.getApkURL)(s,e)})}}()})()})();